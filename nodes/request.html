
<!-- DESCRIPTION -->
<!-- This is the text that appears in the info tab -->
<script type="text/x-red" data-help-name="orchestrator request">
    <p>A direct line to UiPath's Orchestrator.</p>

    <h3>Details</h3>
        <p>This node may perform any action in Orchestrator. See the <a href="https://platform.uipath.com/swagger/ui/index#/">Orchestrator Swagger Doc</a> for a list of available actions & their parameter formatting requirements as well as the <a href="https://orchestrator.uipath.com/v2018.2/reference">Orchestrator API Guide</a> for ideas.</p>

    <br>


    <h3>Properties</h3>
    <dl class="message-properties">
        <h6>Open the node and fill in the following properties:</h6>
        <dt>Login<span class="property-type">String</span></dt>
        <dd>Logs into your Orchestrator tenant so calls may be made.</dd>
        <dt>Category<span class="property-type">String</span></dt>
        <dd>The Orchestrator element with which you'd like to interact <i>(e.g. Robot, Job, Process)</i>.</dd>
        <dt>Action<span class="property-type">String</span></dt>
        <dd>The action to take in the above category.</dd>
        <dt>Parameters<span class="property-type">List</span></dt>
        <dd>Certain actions require more information. Use the add button to prepare all required parameters.<sup>*</sup></dd>
        <br>
        <sup>*Path and query params may be included here as well</sup>
    </dl>


    <br>

    <h3>Output</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">JSON</span></dt>
        <dd>Orchestrator's Response</dd>
    </dl>
</script>


<!-- PROPERTIES -->
<!-- The fields that appear in a node's Edit box -->
<script type="text/x-red" data-template-name="orchestrator request">
    <div class="form-row">
        <label for="name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="name" placeholder="request">
    </div>
    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-sign-in"></i> Login</label>
        <input type="text" id="node-input-connection" placeholder="Orchestrator Login">
    </div>
    <hr>
    <div class="form-row">
        <label for="category"><i class="fa fa-th"></i> Category</label>
        <select id="category">
            <option value="Alerts">Alerts</option>
            <option value="Assets">Assets</option>
            <option value="AuditLogs">AuditLogs</option>
            <option value="Environments">Environments</option>
            <option value="Jobs">Jobs</option>
            <option value="Libraries">Libraries</option>
            <option value="LicensesNamedUser">LicensesNamedUser</option>
            <option value="LicensesRuntime">LicensesRuntime</option>
            <option value="Logs">Logs</option>
            <option value="Machines">Machines</option>
            <option value="MessageTemplates">MessageTemplates</option>
            <option value="OrganizationUnits">OrganizationUnits</option>
            <option value="Permissions">Permissions</option>
            <option value="ProcessSchedules">ProcessSchedules</option>
            <option value="Processes">Processes</option>
            <option value="QueueDefinitions">QueueDefinitions</option>
            <option value="QueueItemComments">QueueItemComments</option>
            <option value="QueueItemEvents">QueueItemEvents</option>
            <option value="QueueItems">QueueItems</option>
            <option value="QueueProcessingRecords">QueueProcessingRecords</option>
            <option value="Queues">Queues</option>
            <option value="Releases">Releases</option>
            <option value="RobotLogs">RobotLogs</option>
            <option value="Robots">Robots</option>
            <option value="Roles">Roles</option>
            <option value="Sessions">Sessions</option>
            <option value="Stats">Stats</option>
            <option value="Tenants">Tenants</option>
            <option value="Users">Users</option>
            <option value="Webhooks">Webhooks</option>
        </select>
    </div>

    <div class="form-row">
        <label for="action"><i class="fa fa-bolt"></i> Action</label>
        <select id="action">
            <!-- Alerts -->
            <option value="GetAll" class="Alerts">Get All</option>
            <option value="GetUnreadCount" class="Alerts">Get Unread Count</option>
            <option value="MarkAsRead" class="Alerts">Mark As Read</option>
            <option value="RaiseProcessAlert" class="Alerts">Raise Process Alert</option>
            <!-- Assets -->
            <option value="GetAll" class="Assets">Get All</option>
            <option value="Create" class="Assets">Create</option>
            <option value="Edit" class="Assets">Edit</option>
            <option value="Delete" class="Assets">Delete</option>
            <option value="GetRobotAssetByNameForRobotKey" class="Assets">Get Robot Asset By Name For Robot Key</option>
            <option value="GetRobotAssetByRobotId" class="Assets">Get Robot Asset By Robot Id</option>
            <option value="GetRobotAssetByRobotidAndAssetname" class="Assets">Get Robot Asset By Robotid And Assetname</option>
            <!-- AuditLogs -->
            <option value="GetAll" class="AuditLogs">Get All</option>
            <option value="GetAuditLogDetailsByAuditlogid" class="AuditLogs">Get Audit Log Details By Auditlogid</option>
            <option value="Reports" class="AuditLogs">Reports</option>
            <!-- Environments -->
            <option value="GetAll" class="Environments">Get All</option>
            <option value="Create" class="Environments">Create</option>
            <option value="GetById" class="Environments">Get By Id</option>
            <option value="Edit" class="Environments">Edit</option>
            <option value="Delete" class="Environments">Delete</option>
            <option value="GetRobotsForEnvironmentByKey" class="Environments">Get Robots For Environment By Key</option>
            <option value="GetRobotIdsForEnvironmentByKey" class="Environments">Get Robot Ids For Environment By Key</option>
            <option value="AddRobot" class="Environments">Add Robot</option>
            <option value="RemoveRobot" class="Environments">Remove Robot</option>
            <option value="SetRobots" class="Environments">Set Robots</option>
            <!-- Jobs -->
            <option value="GetAll" class="Jobs">Get All</option>
            <option value="GetById" class="Jobs">Get By Id</option>
            <option value="StartJobs" class="Jobs">Start Jobs</option>
            <option value="StopJob" class="Jobs">Stop Job</option>
            <option value="StopJobs" class="Jobs">Stop Jobs</option>
            <!-- Libraries -->
            <option value="GetAll" class="Libraries">Get All</option>
            <option value="Delete" class="Libraries">Delete</option>
            <option value="GetVersionsByPackageid" class="Libraries">Get Versions By Packageid</option>
            <option value="DownloadPackageByKey" class="Libraries">Download Package By Key</option>
            <option value="UploadPackage" class="Libraries">Upload Package</option>
            <!-- LicensesNamedUser -->
            <option value="GetLicensesNamedUserByRobottype" class="LicensesNamedUser">Get Licenses Named User By Robottype</option>
            <!-- LicensesRuntime -->
            <option value="GetLicensesRuntimeByRobottype" class="LicensesRuntime">Get Licenses Runtime By Robottype</option>
            <option value="ToggleEnabledByKey" class="LicensesRuntime">Toggle Enabled By Key</option>
            <!-- Logs -->
            <option value="Create" class="Logs">Create</option>
            <option value="SubmitLogs" class="Logs">Submit Logs</option>
            <!-- Machines -->
            <option value="GetAll" class="Machines">Get All</option>
            <option value="Create" class="Machines">Create</option>
            <option value="GetById" class="Machines">Get By Id</option>
            <option value="Edit" class="Machines">Edit</option>
            <option value="Delete" class="Machines">Delete</option>
            <option value="Update" class="Machines">Update</option>
            <option value="DeleteBulk" class="Machines">Delete Bulk</option>
            <!-- MessageTemplates -->
            <option value="GetAll" class="MessageTemplates">Get All</option>
            <option value="Edit" class="MessageTemplates">Edit</option>
            <!-- OrganizationUnits -->
            <option value="GetAll" class="OrganizationUnits">Get All</option>
            <option value="Create" class="OrganizationUnits">Create</option>
            <option value="GetById" class="OrganizationUnits">Get By Id</option>
            <option value="Edit" class="OrganizationUnits">Edit</option>
            <option value="Delete" class="OrganizationUnits">Delete</option>
            <option value="GetUsersForUnitByKey" class="OrganizationUnits">Get Users For Unit By Key</option>
            <option value="GetUserIdsForUnitByKey" class="OrganizationUnits">Get User Ids For Unit By Key</option>
            <option value="SetUsers" class="OrganizationUnits">Set Users</option>
            <!-- Permissions -->
            <option value="GetAll" class="Permissions">Get All</option>
            <!-- ProcessSchedules -->
            <option value="GetAll" class="ProcessSchedules">Get All</option>
            <option value="Create" class="ProcessSchedules">Create</option>
            <option value="GetById" class="ProcessSchedules">Get By Id</option>
            <option value="Edit" class="ProcessSchedules">Edit</option>
            <option value="Delete" class="ProcessSchedules">Delete</option>
            <option value="SetEnabled" class="ProcessSchedules">Set Enabled</option>
            <option value="GetRobotIdsForScheduleByKey" class="ProcessSchedules">Get Robot Ids For Schedule By Key</option>
            <!-- Processes -->
            <option value="GetAll" class="Processes">Get All</option>
            <option value="Delete" class="Processes">Delete</option>
            <option value="GetProcessVersionsByProcessid" class="Processes">Get Process Versions By Processid</option>
            <option value="DownloadPackageByKey" class="Processes">Download Package By Key</option>
            <option value="UploadPackage" class="Processes">Upload Package</option>
            <option value="GetArgumentsByKey" class="Processes">Get Arguments By Key</option>
            <option value="SetArguments" class="Processes">Set Arguments</option>
            <!-- QueueDefinitions -->
            <option value="GetAll" class="QueueDefinitions">Get All</option>
            <option value="Create" class="QueueDefinitions">Create</option>
            <option value="GetById" class="QueueDefinitions">Get By Id</option>
            <option value="Edit" class="QueueDefinitions">Edit</option>
            <option value="Delete" class="QueueDefinitions">Delete</option>
            <option value="Reports" class="QueueDefinitions">Reports</option>
            <!-- QueueItemComments -->
            <option value="GetAll" class="QueueItemComments">Get All</option>
            <option value="Create" class="QueueItemComments">Create</option>
            <option value="GetById" class="QueueItemComments">Get By Id</option>
            <option value="Edit" class="QueueItemComments">Edit</option>
            <option value="Delete" class="QueueItemComments">Delete</option>
            <option value="GetQueueItemCommentsHistoryByQueueitemid" class="QueueItemComments">Get Queue Item Comments History By Queueitemid</option>
            <!-- QueueItemEvents -->
            <option value="GetAll" class="QueueItemEvents">Get All</option>
            <option value="GetById" class="QueueItemEvents">Get By Id</option>
            <option value="GetQueueItemEventsHistoryByQueueitemid" class="QueueItemEvents">Get Queue Item Events History By Queueitemid</option>
            <!-- QueueItems -->
            <option value="GetAll" class="QueueItems">Get All</option>
            <option value="GetById" class="QueueItems">Get By Id</option>
            <option value="Delete" class="QueueItems">Delete</option>
            <option value="GetItemProcessingHistory" class="QueueItems">Get Item Processing History</option>
            <option value="SetItemReviewStatus" class="QueueItems">Set Item Review Status</option>
            <option value="DeleteBulk" class="QueueItems">Delete Bulk</option>
            <option value="SetTransactionProgress" class="QueueItems">Set Transaction Progress</option>
            <option value="SetItemReviewer" class="QueueItems">Set Item Reviewer</option>
            <option value="UnsetItemReviewer" class="QueueItems">Unset Item Reviewer</option>
            <option value="GetReviewers" class="QueueItems">Get Reviewers</option>
            <!-- QueueProcessingRecords -->
            <option value="RetrieveLastDaysProcessingRecordsByDaysnoAndQueuedefinitionid" class="QueueProcessingRecords">Retrieve Last Days Processing Records</option>
            <option value="RetrieveQueuesProcessingStatus" class="QueueProcessingRecords">Retrieve Queues Processing Status</option>
            <!-- Queues -->
            <option value="StartTransaction" class="Queues">Start Transaction</option>
            <option value="AddQueueItem" class="Queues">Add Queue Item</option>
            <option value="SetTransactionResult" class="Queues">Set Transaction Result</option>
            <!-- Releases -->
            <option value="GetAll" class="Releases">Get All</option>
            <option value="Create" class="Releases">Create</option>
            <option value="GetById" class="Releases">Get By Id</option>
            <option value="Edit" class="Releases">Edit</option>
            <option value="Delete" class="Releases">Delete</option>
            <option value="Update" class="Releases">Update</option>
            <option value="UpdateToSpecificPackageVersion" class="Releases">Update To Specific Package Version</option>
            <option value="UpdateToLatestPackageVersion" class="Releases">Update To Latest Package Version</option>
            <option value="RollbackToPreviousReleaseVersion" class="Releases">Rollback To Previous Release Version</option>
            <!-- RobotLogs -->
            <option value="GetAll" class="RobotLogs">Get All</option>
            <option value="GetTotalCount" class="RobotLogs">Get Total Count</option>
            <option value="Reports" class="RobotLogs">Reports</option>
            <!-- Robots -->
            <option value="GetAll" class="Robots">Get All</option>
            <option value="Create" class="Robots">Create</option>
            <option value="GetById" class="Robots">Get By Id</option>
            <option value="Edit" class="Robots">Edit</option>
            <option value="Delete" class="Robots">Delete</option>
            <option value="GetMachineNameToLicenseKeyMappings" class="Robots">Get Machine Name To License Key Mappings</option>
            <option value="GetUsernames" class="Robots">Get Usernames</option>
            <option value="GetRobotsForProcessByProcessid" class="Robots">Get Robots For Process By Processid</option>
            <option value="DeleteBulk" class="Robots">Delete Bulk</option>
            <option value="ConvertToFloating" class="Robots">Convert To Floating</option>
            <!-- Roles -->
            <option value="GetAll" class="Roles">Get All</option>
            <option value="Create" class="Roles">Create</option>
            <option value="GetById" class="Roles">Get By Id</option>
            <option value="Edit" class="Roles">Edit</option>
            <option value="Delete" class="Roles">Delete</option>
            <option value="GetUsersForRoleByKey" class="Roles">Get Users For Role By Key</option>
            <option value="GetUserIdsForRoleByKey" class="Roles">Get User Ids For Role By Key</option>
            <option value="SetUsers" class="Roles">Set Users</option>
            <!-- Sessions -->
            <option value="GetAll" class="Sessions">Get All</option>
            <!-- Stats -->
            <option value="GetCountStats" class="Stats">Get Count Stats</option>
            <option value="GetSessionsStats" class="Stats">Get Sessions Stats</option>
            <option value="GetJobsStats" class="Stats">Get Jobs Stats</option>
            <option value="GetLicenseStats" class="Stats">Get License Stats</option>
            <!-- Tenants -->
            <option value="GetAll" class="Tenants">Get All</option>
            <option value="Create" class="Tenants">Create</option>
            <option value="GetById" class="Tenants">Get By Id</option>
            <option value="Delete" class="Tenants">Delete</option>
            <option value="SetActive" class="Tenants">Set Active</option>
            <!-- Users -->
            <option value="GetAll" class="Users">Get All</option>
            <option value="Create" class="Users">Create</option>
            <option value="GetById" class="Users">Get By Id</option>
            <option value="Edit" class="Users">Edit</option>
            <option value="Delete" class="Users">Delete</option>
            <option value="Update" class="Users">Update</option>
            <option value="GetCurrentPermissions" class="Users">Get Current Permissions</option>
            <option value="GetCurrentUser" class="Users">Get Current User</option>
            <option value="ToggleRole" class="Users">Toggle Role</option>
            <option value="ImportUsers" class="Users">Import Users</option>
            <option value="ToggleOrganizationUnit" class="Users">Toggle Organization Unit</option>
            <option value="ChangePassword" class="Users">Change Password</option>
            <option value="SetActive" class="Users">Set Active</option>
            <option value="ChangeCulture" class="Users">Change Culture</option>
            <option value="UpdatePassword" class="Users">Update Password</option>
            <!-- Webhooks -->
            <option value="GetAll" class="Webhooks">Get All</option>
            <option value="Create" class="Webhooks">Create</option>
            <option value="GetById" class="Webhooks">Get By Id</option>
            <option value="Edit" class="Webhooks">Edit</option>
            <option value="Delete" class="Webhooks">Delete</option>
            <option value="Update" class="Webhooks">Update</option>
            <option value="Ping" class="Webhooks">Ping</option>
            <option value="GetEventTypes" class="Webhooks">Get Event Types</option>
            <option value="TriggerCustom" class="Webhooks">Trigger Custom</option>
        </select>
    </div>

    <div class="form-row node-input-rule-container-row">
        <label for="node-input-param-container">Parameters</label>
        <ol id="node-input-param-container"></ol>
    </div>
</script>


<!-- JAVASCRIPT -->
<!-- Controls the setup and persistence of a node -->
<script type="text/javascript">

    RED.nodes.registerType('orchestrator request',{
        category: 'orchestrator',
        color: '#0085CA',
        defaults: {
            name: {value: ""},
            nameSet: {value: false},
            connection: {type:"orchestrator connection", required: true},
            category: {value:""},
            action: {value: ""},
            params: {value: [{key: "", type: "str", value: ""}]}
        },
        icon: "uipathLogo.svg",
        inputs: 1,
        outputs: 1,
        paletteLabel: 'request',
        label: function() { 
                var label = this.name || "request";
                return (label.length <= 20) ? label : (label.substring(0,18) + "...");
            },
        oneditprepare: function() {

            // Create structure for params list
            $('#node-input-param-container').editableList({
                addItem: function(row,i,data) {
                    
                    // Ensure no overflow within row
                    row.css( { overflow: 'hidden', whiteSpace: 'nowrap' } );

                    // Add new key-value pair
                    var key = $('<input type="text" class="rowKey" placeholder="Key">').appendTo(row);
                    if (data.key) $(key).val(data.key);

                    var value = $('<input type="text" class="rowVal node-input-params-value" placeholder="Value">').appendTo(row);
                    $(value).typedInput({
                        default: "str",
                        types: ["str","num","bool","json","date","msg","flow","global",'jsonata']
                    });
                    if (data.value) {
                        $(value).typedInput('type', data.type);
                        $(value).typedInput('value', data.value);
                    }
                    
                },
                removable: true,
                sortable: true
            });


            // Fill in persisted values
            if (this.nameSet) $('#name').val(this.name);
            $('#category').val(this.category || "Alerts");
            $('#action').val(this.action || "GetAll");
            try {
                for (var row of this.params)
                    $("#node-input-param-container").editableList('addItem', row);
            } catch(TypeError) {}

            // Fill in appropriate actions...
            function checkCategory() {
                var category = $('#category').val();
                $('#action option:not(.'+category+')').hide();
                $('#action option.'+category).show();
                $('#action option.'+category).show();
            }

            // ...when opening node
            checkCategory();

            // ...or when the category changes
            $("#category").off().on('change', function() {
                $("#action").val('');   // Clear selected action
                checkCategory();
            });

        },
        oneditsave: function() {
            var node = this;
            node.category = $('#category').val();   // Save Category
            node.action = $("#action").val();       // Save Action

            // Save Name
            node.name = $('#name').val() || node.category + ": " + $("#action :selected").text();
            node.nameSet = !!$('#name').val();
            
            // Save Parameters
            node.params = [];
            var params = $("#node-input-param-container").editableList('items');
            params.each(function(i) {
                var row = {
                    key: $(this).find(".rowKey").val(),
                    type: $(this).find(".node-input-params-value").typedInput('type'),
                    value: $(this).find(".node-input-params-value").typedInput('value')
                };
                
                node.params.push(row);
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0; i<rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#node-input-param-container").editableList('height',height);
        }
    });
</script>


<!-- CSS -->
<!-- Style, baby -->
<style>
    .rowKey, .red-ui-typedInput-container {
        width: 48% !important;
        margin-right: 2%; 
    }

    .node-input-rule-container-row .red-ui-editableList-container {
        height: auto !important;
        max-height: 16em !important;
    }
</style>