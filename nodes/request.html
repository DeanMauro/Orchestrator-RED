
<!-- DESCRIPTION -->
<!-- This is the text that appears in the info tab -->
<script type="text/x-red" data-help-name="orchestrator request">
    <p>A direct line to UiPath's Orchestrator.</p>

    <h3>Details</h3>
    <dl class="message-properties">
        <p>You can instruct this node to contact Orchestrator by filling in its properties as per the Orchestrator API guidelines.</p>
        <p>See the <a href="https://orchestrator.uipath.com/v2018.1/reference">Orchestrator API Guide</a> for a list of available calls.</p>
    </dl>

    <br>


    <h3>Inputs</h3>
    <dl class="message-properties">
        <h6>Open the node and fill in the following properties:</h6>
        <dt>Category<span class="property-type">String</span></dt>
        <dd>The Orchestrator element you wish to interact with <i>(e.g. Robot, Job, Process)</i>.</dd>
        <dt>Action<span class="property-type">String</span></dt>
        <dd>The action to take in the above category.</dd>
        <dt>Parameters<span class="property-type">List</span></dt>
        <dd>Certain actions require more information. Use the add button to prepare all required parameters.</dd>
    </dl>


    <br>

    <h3>Output</h3>
    <dl class="message-properties">
        <dt>Orchestrator's Response<span class="property-type">JSON</span></dt>
    </dl>
</script>


<!-- PROPERTIES -->
<!-- The fields that appear in a node's Edit box -->
<script type="text/x-red" data-template-name="orchestrator request">
    <div class="form-row">
        <label for="name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="name" placeholder="request">
    </div>
    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-sign-in"></i> Login</label>
        <input type="text" id="node-input-connection" placeholder="Orchestrator Login">
    </div>
    <hr>
    <div class="form-row">
        <label for="category"><i class="fa fa-th"></i> Category</label>
        <select id="category">
            <option value="Alerts">Alerts</option>
            <option value="Assets">Assets</option>
            <option value="AuditLogs">Audit Logs</option>
            <option value="Environments">Environments</option>
            <option value="Jobs">Jobs</option>
            <option value="OrganizationUnits">Organization Units</option>
            <option value="Permissions">Permissions</option>
            <option value="Processes">Processes</option>
            <option value="ProcessSchedules">Process Schedules</option>
            <option value="QueueDefinitions">Queue Definitions</option>
            <option value="QueueItemEvents">Queue Item Events</option>
            <option value="QueueItemComments">Queue Item Comments</option>
            <option value="QueueItems">Queue Items</option>
            <option value="QueueProcessingRecords">Queue Processing Records</option>
            <option value="Queues">Queues</option>
            <option value="Releases">Releases</option>
            <option value="RobotLogs">Robot Logs</option>
            <option value="Robots">Robots</option>
            <option value="Roles">Roles</option>
            <option value="Sessions">Sessions</option>
            <option value="Stats">Stats</option>
            <option value="Tenants">Tenants</option>
            <option value="Users">Users</option>
        </select>
    </div>

    <div class="form-row">
        <label for="action"><i class="fa fa-bolt"></i> Action</label>
        <select id="action">
            <!-- General -->
            <option value="GetAll" class="Alerts Assets AuditLogs Environments Jobs OrganizationUnits Permissions Processes ProcessSchedules QueueDefinitions QueueItemComments QueueItemEvents QueueItems QueueProcessingRecords Queues Releases RobotLogs Robots Roles Sessions Tenants Users">Get All</option>
            <option value="GetOne" class="Environments Jobs OrganizationUnits ProcessSchedules QueueDefinitions QueueItemComments QueueItemEvents QueueItems QueueProcessingRecords Queues Releases Robots Tenants Users">Get One</option>
            <option value="Create" class="Assets Environments OrganizationUnits ProcessSchedules QueueDefinitions QueueItemComments QueueProcessingRecords Releases Robots Roles Tenants Users">Create</option>
            <option value="Delete" class="Assets Environments OrganizationUnits ProcessSchedules QueueDefinitions QueueItemComments QueueItems QueueProcessingRecords Releases Robots Roles Tenants Users">Delete</option>
            <option value="Edit" class="Assets OrganizationUnits ProcessSchedules QueueDefinitions Releases Robots Roles Tenants Users">Edit</option>
            <option value="Update" class="Environments">Update</option>
            <!-- Alerts -->
            <option value="GetUnreadCount" class="Alerts">Get Unread Count</option>
            <option value="MarkAsRead" class="Alerts">Mark As Read</option>
            <option value="RaiseProcessAlert" class="Alerts">Raise Process Alert</option>
            <!-- Assets -->
            <option value="GetRobotAsset" class="Assets">Get Robot-Associated Asset</option>
            <!-- Audit Logs -->
            <option value="GetAuditLogDetails" class="AuditLogs">Get Audit Log Details</option>
            <!-- Environments -->
            <option value="GetRobotsForEnvironment" class="Environments">Get Robots in Environment</option>
            <option value="GetRobotIdsForEnvironment" class="Environments">Get Robot Ids in Environment</option>
            <option value="AddRobot" class="Environments">Associate Robot</option>
            <option value="RemoveRobot" class="Environments">Dissociate Robot</option>
            <option value="SetRobots" class="Environments">Set Robots</option>
            <!-- Jobs -->
            <option value="Create" class="Jobs">Post New Entity to EntitySet Jobs</option>
            <option value="Update" class="Jobs">Replace Entity in EntitySet Jobs</option>
            <option value="StartJobs" class="Jobs">Start Job</option>
            <option value="StopJob" class="Jobs">Stop Job</option>
            <!-- Organization Units -->
            <option value="GetUsersForUnit" class="OrganizationUnits">Get Users for Unit</option>
            <option value="GetUserIdsForUnit" class="OrganizationUnits">Get User Ids for Unit</option>
            <option value="SetUsers" class="OrganizationUnits">Set Users</option>
            <!-- Processes -->
            <option value="Delete" class="Processes">Delete Package</option>
            <option value="GetProcessVersions" class="Processes">Get Process Versions</option>
            <!-- Process Schedules -->
            <option value="SetEnabled" class="ProcessSchedules">Enable/Disable</option>
            <option value="GetRobotIdsForSchedule" class="ProcessSchedules">Get Robot Ids</option>
            <!-- Queue Item Comments -->
            <option value="Update" class="QueueItemComments">Replace Entity in EntitySet QueueItemComments</option>
            <option value="GetQueueItemCommentsHistory" class="QueueItemComments">Get History</option>
            <!-- Queue Item Events -->
            <option value="GetQueueItemEventsHistory" class="QueueItemEvents">Get History</option>
            <!-- Queue Items -->
            <option value="Create" class="QueueItems">Post Entity to EntitySet QueueItems</option>
            <option value="Replace" class="QueueItems">Replace Entity in EntitySet QueueItems</option>
            <option value="Update" class="QueueItems">Update Entity in EntitySet QueueItems</option>
            <option value="GetItemProcessingHistory" class="QueueItems">Get Item Processing History</option>
            <option value="SetItemReviewStatus" class="QueueItems">Set Item Review Status</option>
            <option value="DeleteBulk" class="QueueItems">Set Statuses to Deleted</option>
            <option value="SetTransactionProgress" class="QueueItems">Update Status to 'In Progress'</option>
            <option value="SetItemReviewer" class="QueueItems">Set Item Reviewer</option>
            <option value="UnsetItemReviewer" class="QueueItems">Unset Item Reviewer</option>
            <option value="GetReviewers" class="QueueItems">Get Reviewers</option>
            <!-- Queue Processing Records -->
            <option value=RetrieveLastDaysProcessingRecords" class="QueueProcessingRecords">Get Records for Last X Days</option>
            <option value="RetrieveQueuesProcessingStatus" class="QueueProcessingRecords">Get Processing Status for All Queues</option>
            <!-- Queues -->
            <option value="StartTransaction" class="Queues">Start Transaction</option>
            <option value="AddQueueItem" class="Queues">Add a Queue Item</option>
            <option value="SetTransactionResult" class="Queues">Set Result of Transaction</option>
            <!-- Releases -->
            <option value="UpdateToSpecificPackageVersion" class="Releases">Update Package Version to a Given Release</option>
            <option value="UpdateToLatestPackageVersion" class="Releases">Update Package Version to Latest Release</option>
            <option value="RollbackToPreviousReleaseVersion" class="Releases">Revert Package Version to Most Recent</option>
            <!-- Robot Logs -->
            <option value="Reports" class="RobotLogs">Get Reports</option>
            <!-- Robots -->
            <option value="GetMachineNameToLicenseKeyMappings" class="Robots">Get Machine Name to License Key Mappings</option>
            <!-- Roles -->
            <option value="GetUsersForRole" class="Roles">Get Users for Role</option>
            <option value="GetUserIdsForRole" class="Roles">Get User Ids for Role</option>
            <option value="SetUsers" class="Roles">Set Users</option>
            <!-- Stats -->
            <option value="GetCountStats" class="Stats">Get Entity Counts</option>
            <option value="GetSessionsStats" class="Stats">Get Robot Counts</option>
            <option value="GetJobsStats" class="Stats">Get Job Counts</option>
            <!-- Tenants -->
            <option value="SetActive" class="Tenants">Activate/Deactivate</option>
            <!-- Users -->
            <option value="GetCurrentPermissions" class="Users">Get User Permissions</option>
            <option value="GetCurrentUser" class="Users">Get Details About Current User</option>
            <option value="ToggleRole" class="Users">Associate/Dissociate User from Role</option>
            <option value="ToggleOrganizationUnit" class="Users">Associate/Dissociate User from Organization Unit</option>
            <option value="ImportUsers" class="Users">Import Users and Associate Them with Given Roles</option>
            <option value="ChangePassword" class="Users">Change User's Password</option>
            <option value="SetActive" class="Users">Activate/Deactivate</option>
        </select>
    </div>

    <div class="form-row node-input-rule-container-row">
        <label for="node-input-param-container">Parameters</label>
        <ol id="node-input-param-container"></ol>
    </div>
</script>


<!-- JAVASCRIPT -->
<!-- Controls the setup and persistence of a node -->
<script type="text/javascript">

    RED.nodes.registerType('orchestrator request',{
        category: 'orchestrator',
        color: '#0085CA',
        defaults: {
            name: {value: ""},
            nameSet: {value: false},
            connection: {type:"orchestrator connection", required: true},
            category: {value:""},
            action: {value: ""},
            params: {value: [{key: "", type: "str", value: ""}]}
        },
        icon: "uipathLogo.svg",
        inputs: 1,
        outputs: 1,
        paletteLabel: 'request',
        label: function() { 
                var label = this.name || "request";
                return (label.length <= 20) ? label : (label.substring(0,18) + "...");
            },
        oneditprepare: function() {

            // Create structure for params list
            $('#node-input-param-container').editableList({
                addItem: function(row,i,data) {
                    
                    // Ensure no overflow within row
                    row.css( { overflow: 'hidden', whiteSpace: 'nowrap' } );

                    // Add new key-value pair
                    var key = $('<input type="text" class="rowKey" placeholder="Key">').appendTo(row);
                    if (data.key) $(key).val(data.key);

                    var value = $('<input type="text" class="rowVal node-input-params-value" placeholder="Value">').appendTo(row);
                    $(value).typedInput({
                        default: "str",
                        types: ["str","num","bool","json","date","msg","flow","global",'jsonata']
                    });
                    if (data.value) {
                        $(value).typedInput('type', data.type);
                        $(value).typedInput('value', data.value);
                    }
                    
                },
                removable: true,
                sortable: true
            });


            // Fill in persisted values
            if (this.nameSet) $('#name').val(this.name);
            $('#category').val(this.category || "Alerts");
            $('#action').val(this.action || "GetAll");
            try {
                for (var row of this.params)
                    $("#node-input-param-container").editableList('addItem', row);
            } catch(TypeError) {}

            // Fill in appropriate actions...
            function checkCategory() {
                var category = $('#category').val();
                $('#action option:not(.'+category+')').hide();
                $('#action option.'+category).show();
                $('#action option.'+category).show();
            }

            // ...when opening node
            checkCategory();

            // ...or when the category changes
            $("#category").off().on('change', function() {
                $("#action").val('');   // Clear selected action
                checkCategory();
            });

        },
        oneditsave: function() {
            var node = this;
            node.category = $('#category').val();   // Save Category
            node.action = $("#action").val();       // Save Action

            // Save Name
            node.name = $('#name').val() || node.category + ": " + $("#action :selected").text();
            node.nameSet = !!$('#name').val();
            
            // Save Parameters
            node.params = [];
            var params = $("#node-input-param-container").editableList('items');
            params.each(function(i) {
                var row = {
                    key: $(this).find(".rowKey").val(),
                    type: $(this).find(".node-input-params-value").typedInput('type'),
                    value: $(this).find(".node-input-params-value").typedInput('value')
                };
                
                node.params.push(row);
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0; i<rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#node-input-param-container").editableList('height',height);
        }
    });
</script>


<!-- CSS -->
<!-- Style, baby -->
<style>
    .rowKey, .red-ui-typedInput-container {
        width: 48% !important;
        margin-right: 2%; 
    }
</style>